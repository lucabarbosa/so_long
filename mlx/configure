#!/bin/sh

set -e

BOLD="\e[1m"
RESET="\e[0m"
LIGHT_RED="\e[91m"
LIGHT_GREEN="\e[92m"
LIGHT_CYAN="\e[96m"

logging(){
    :
}
log_info(){
    :
}
log_error(){
    :
}

get_xlib_include_path(){
    local result=""

    for inc in \
        /usr/X11/include          \
        /usr/X11R6/include        \
        /usr/X11R5/include        \
        /usr/X11R4/include        \
                                \
        /usr/include              \
        /usr/include/X11          \
        /usr/include/X11R6        \
        /usr/include/X11R5        \
        /usr/include/X11R4        \
                                \
        /usr/local/X11/include    \
        /usr/local/X11R6/include  \
        /usr/local/X11R5/include  \
        /usr/local/X11R4/include  \
                                \
        /usr/local/include/X11    \
        /usr/local/include/X11R6  \
        /usr/local/include/X11R5  \
        /usr/local/include/X11R4  \
                                \
        /usr/X386/include         \
        /usr/x386/include         \
        /usr/XFree86/include/X11  \
                                \
        /usr/local/include        \
        /usr/athena/include       \
        /usr/local/x11r5/include  \
        /usr/lpp/Xamples/include  \
                                \
        /usr/openwin/include      \
        /usr/openwin/share/include
    do
        if [ -f "$inc/X11/Xlib.h" -a -f "$inc/X11/extensions/XShm.h" ]; then
            result=$inc
            break
        fi
    done
    echo $result
}

show_help(){
    :
}

clean(){
    make -f Makefile.gen clean > /dev/null 2>&1
    make -f Makefile.gen -C test/ --no-print-directory clean > /dev/null 2>&1
}

parse_args(){
    case "$1" in
        --help | -h)
            show_help
            exit 0;;
        clean)
            clean
            exit 0;;
        "")
            return;;
        *)
            log_error "unknown command \"$1\"\nRun \"./configure --help\" for usage."
            exit 1;;
    esac
}

main(){
    local xlib_inc="$(get_xlib_include_path)"

    parse_args "$@"
    if [ -z "$xlib_inc" ]; then
        log_error "Can't find a suitable X11 include directory."
        exit 1
    fi

    echo "INC=$xlib_inc" > Makefile.gen
    cat Makefile.mk | grep -v %%%% >> Makefile.gen

    echo "INC=$xlib_inc" > test/Makefile.gen
    cat test/Makefile.mk | grep -v %%%% >> test/Makefile.gen

    make -f Makefile.gen all > /dev/null 2>&1
    (cd test ; make -f Makefile.gen all > /dev/null 2>&1)
}

main "$@"
